<!-- build time:Thu Feb 17 2022 12:37:56 GMT+0000 (Coordinated Universal Time) --><!DOCTYPE html><html><head><meta charset="utf-8"><title>源码角度分析Shiro认证流程以及一个前后端分离案例 |</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#3F51B5"><meta name="keywords" content="Web,Shiro,Security"><meta name="description" content="从源码去分析认证流程前，你需要知道Shiro是什么，以及Shiro中的基本组件。在看本篇文章前，我假设你已经知道上述东西，并且后续的分析不会对这些组件是什么进行讲解。如果你并不了解Shiro可以看下我的这篇博文：Shiro简介 对于更详细的分析，大家可以百度、google一下，资料应该是很全的。Shiro工作流程简述Shiro进行认证的本质还是通过过滤器进行拦截，过滤器拦截后判断是否需要进行认证，"><meta property="og:type" content="article"><meta property="og:title" content="源码角度分析Shiro认证流程以及一个前后端分离案例"><meta property="og:url" content="https://lolico.me/2020/02/04/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Shiro%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8A%E4%B8%80%E4%B8%AA%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%A1%88%E4%BE%8B/index.html"><meta property="og:site_name" content=""><meta property="og:description" content="从源码去分析认证流程前，你需要知道Shiro是什么，以及Shiro中的基本组件。在看本篇文章前，我假设你已经知道上述东西，并且后续的分析不会对这些组件是什么进行讲解。如果你并不了解Shiro可以看下我的这篇博文：Shiro简介 对于更详细的分析，大家可以百度、google一下，资料应该是很全的。Shiro工作流程简述Shiro进行认证的本质还是通过过滤器进行拦截，过滤器拦截后判断是否需要进行认证，"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://lolico.griouges.cn/images/NKaB.png"><meta property="article:published_time" content="2020-02-04T10:50:51.000Z"><meta property="article:modified_time" content="2022-02-17T12:36:57.927Z"><meta property="article:author" content="mmmmx"><meta property="article:tag" content="Web"><meta property="article:tag" content="Shiro"><meta property="article:tag" content="Security"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://lolico.griouges.cn/images/NKaB.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css"><script>window.lazyScripts=[]</script><meta name="generator" content="Hexo 4.2.1"></head><body><div id="loading" class="active"></div><aside id="menu" class="hide"><div class="inner flex-row-vertical"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off"><i class="icon icon-lg icon-close"></i></a><div class="brand-wrap" style="background-image:url(/img/brand.jpg)"><div class="brand"><a href="/" class="avatar waves-effect waves-circle waves-light"><img src="/img/avatar.jpg"></a><hgroup class="introduce"><h5 class="nickname">mmmmx</h5><a href="mailto:534619360@qq.com" title="534619360@qq.com" class="mail">534619360@qq.com</a></hgroup></div></div><div class="scroll-wrap flex-col"><ul class="nav"><li class="waves-block waves-effect"><a href="/"><i class="icon icon-lg icon-home"></i> Home</a></li><li class="waves-block waves-effect"><a href="/archives"><i class="icon icon-lg icon-archives"></i> Archives</a></li><li class="waves-block waves-effect"><a href="/tags"><i class="icon icon-lg icon-tags"></i> Tags</a></li><li class="waves-block waves-effect"><a href="/categories"><i class="icon icon-lg icon-th-list"></i> Categories</a></li><li class="waves-block waves-effect"><a href="https://github.com/c3b2a7" target="_blank"><i class="icon icon-lg icon-github"></i> Github</a></li><li class="waves-block waves-effect"><a href="https://twitter.com/_lovebirdy" target="_blank"><i class="icon icon-lg icon-twitter"></i> Twitter</a></li><li class="waves-block waves-effect"><a href="/about"><i class="icon icon-lg icon-info-circle"></i> About</a></li></ul></div></div></aside><main id="main"><header class="top-header" id="header"><div class="flex-row"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle"><i class="icon icon-lg icon-navicon"></i></a><div class="flex-col header-title ellipsis">源码角度分析Shiro认证流程以及一个前后端分离案例</div><div class="search-wrap" id="search-wrap"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back"><i class="icon icon-lg icon-chevron-left"></i> </a><input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字"> <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search"><i class="icon icon-lg icon-search"></i></a></div><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare"><i class="icon icon-lg icon-share-alt"></i></a></div></header><header class="content-header post-header"><div class="container fade-scale"><h1 class="title">源码角度分析Shiro认证流程以及一个前后端分离案例</h1><h5 class="subtitle"><time datetime="2020-02-04T10:50:51.000Z" itemprop="datePublished" class="page-time">2020-02-04</time><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E6%AD%A3%E5%B8%B8%E7%9A%84%E6%96%87%E7%AB%A0/">正常的文章</a></li></ul></h5></div></header><div class="container body-wrap"><aside class="post-widget"><nav class="post-toc-wrap post-toc-shrink" id="post-toc"><h4>TOC</h4><ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Shiro工作流程简述"><span class="post-toc-number">1.</span> <span class="post-toc-text">Shiro工作流程简述</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#过滤器"><span class="post-toc-number">2.</span> <span class="post-toc-text">过滤器</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#AdviceFilter类、PathMatchingFilter类和AccessControlFilter类"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">AdviceFilter类、PathMatchingFilter类和AccessControlFilter类</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#AuthenticationFilter类和AuthenticatingFilter类"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">AuthenticationFilter类和AuthenticatingFilter类</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#SecurityManager"><span class="post-toc-number">3.</span> <span class="post-toc-text">SecurityManager</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#一个前后端分离案例"><span class="post-toc-number">4.</span> <span class="post-toc-text">一个前后端分离案例</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#后语"><span class="post-toc-number">5.</span> <span class="post-toc-text">后语</span></a></li></ol></nav></aside><article id="post-源码角度分析Shiro认证流程以及一个前后端分离案例" class="post-article article-type-post fade" itemprop="blogPost"><div class="post-card"><h1 class="post-card-title">源码角度分析Shiro认证流程以及一个前后端分离案例</h1><div class="post-meta"><time class="post-time" title="2020-02-04 18:50:51" datetime="2020-02-04T10:50:51.000Z" itemprop="datePublished">2020-02-04</time><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E6%AD%A3%E5%B8%B8%E7%9A%84%E6%96%87%E7%AB%A0/">正常的文章</a></li></ul><span id="busuanzi_container_page_pv" title="文章总阅读量" style="display:none"><i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span></span></div><div class="post-content" id="post-content" itemprop="postContent"><p>从源码去分析认证流程前，你需要知道Shiro是什么，以及Shiro中的基本组件。在看本篇文章前，我假设你已经知道上述东西，并且后续的分析不会对这些组件是什么进行讲解。</p><p>如果你并不了解Shiro可以看下我的这篇博文：<a href="/2020/02/04/Shiro%E7%AE%80%E4%BB%8B/" title="Shiro简介">Shiro简介</a> 对于更详细的分析，大家可以百度、google一下，资料应该是很全的。</p><h2 id="Shiro工作流程简述"><a href="#Shiro工作流程简述" class="headerlink" title="Shiro工作流程简述"></a>Shiro工作流程简述</h2><p>Shiro进行认证的本质还是通过过滤器进行拦截，过滤器拦截后判断是否需要进行认证，如果需要，取出”token”并交给<code>SecurityManager</code>进行认证，认证通过后放行，如果不需要认证则直接放行。</p><p>至于为什么token打上引号，是因为token并不一定是普遍意义上的JWT（json web token）,也可以是基于BASIC HTTP的token，还可以是表单中的用户名和密码…</p><p>所以Shiro中就内置了一些常用的Filter，有基于表单认证的<code>FormAuthenticationFilter</code>类和基于BASIC HTTP的<code>BasicHttpAuthenticationFilter</code>类，还有不需要认证直接放行的<code>AnonymousFilter</code>类，也有一些用于检查<code>Roles</code>和<code>Permissions</code>的过滤器，具体的可以去<code>DefaultFilter</code>中看看。</p><h2 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h2><p>Shiro中的过滤器其实还是Servlet中的Filter，只不过对其进行了封装。</p><p>先来看下Shiro中Filter的类图</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div><img src="https://lolico.griouges.cn/images/NKaB.png" alt="Shiro Filter"></div><div class="image-caption">Shiro Filter</div></figure><ul><li><code>AbstractFilter</code>：提供了简化的初始化逻辑和access到初始化参数，并且提供了<code>getInitParam(String paramName)</code>方法获取。</li><li><code>NameableFilter</code>：为Filter提供<code>name</code>属性值，可通过getter和setter方法获取和设置。</li><li><code>OncePerRequestFilter</code>：继承自<code>NameableFilter</code>，通过名字看出，一次请求执行一次。</li></ul><p>不难看出Shiro中的所有Filter都是通过继承<code>OncePerRequestFilter</code>抽象类而来，来看下这个类的<code>doFilter(...)</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain filterChain)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    String alreadyFilteredAttributeName = getAlreadyFilteredAttributeName();</span><br><span class="line">    <span class="keyword">if</span> ( request.getAttribute(alreadyFilteredAttributeName) != <span class="keyword">null</span> ) &#123;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isEnabled(request, response) || shouldNotFilter(request) ) &#123;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request.setAttribute(alreadyFilteredAttributeName, Boolean.TRUE);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            doFilterInternal(request, response, filterChain);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            request.removeAttribute(alreadyFilteredAttributeName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 默认实现是使用过滤器的name作为属性名，如果为空则用类的全路径名作为属性名</span></span><br><span class="line"><span class="comment">// 这个属性名一般来说是唯一的</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getAlreadyFilteredAttributeName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String name = getName();</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">        name = getClass().getName();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> name + ALREADY_FILTERED_SUFFIX; <span class="comment">// ALREADY_FILTERED_SUFFIX = ".FILTERED";</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看出首先调用<code>getAlreadyFilteredAttributeName()</code>获取当前过滤器的属性名，该方法的默认实现是使用过滤器的name作为属性名，如果为空则用类的全路径名作为属性名，这个属性名一般来说是唯一的。获取到属性名后看下request中有没有这个属性，如果存在，则放行，继续执行下一个过滤器。如果不存在，则继续判断过滤器是否启用，或者是否直接放行，如果是则也放行，最后上述两种情况都不符合，也就是说需要进行过滤,先将过滤器的属性名设置到这次请求中，再尝试进行具体逻辑<code>doFilterInternal(...)</code>方法（该方法是抽象方法，需要子类实现），最后finally中逻辑显而易见，过滤器具体逻辑执行完毕后移除过滤器的属性名。</p><p>说的简单点，也就是实现了一次请求过滤一次，然后将过滤器具体的逻辑放在了这个抽象方法中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException</span>;</span><br></pre></td></tr></table></figure><h3 id="AdviceFilter类、PathMatchingFilter类和AccessControlFilter类"><a href="#AdviceFilter类、PathMatchingFilter类和AccessControlFilter类" class="headerlink" title="AdviceFilter类、PathMatchingFilter类和AccessControlFilter类"></a><code>AdviceFilter</code>类、<code>PathMatchingFilter</code>类和<code>AccessControlFilter</code>类</h3><p><strong>AdviceFilte类</strong></p><p><code>AdviceFilter</code>类继承自<code>OncePerRequestFilter</code>，也是个抽象类，但他实现了父类的<code>doFilterInternal(...)</code>方法中，将具体逻辑又分为三个步骤：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    Exception exception = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//执行前置处理</span></span><br><span class="line">        <span class="keyword">boolean</span> continueChain = preHandle(request, response);</span><br><span class="line">        <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">            log.trace(<span class="string">"Invoked preHandle method.  Continuing chain?: ["</span> + continueChain + <span class="string">"]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//前置处理如果没问题，执行executeChain(...)方法</span></span><br><span class="line">        <span class="keyword">if</span> (continueChain) &#123;</span><br><span class="line">            executeChain(request, response, chain);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//执行后置处理</span></span><br><span class="line">        postHandle(request, response);</span><br><span class="line">        <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">            log.trace(<span class="string">"Successfully invoked postHandle method"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        exception = e;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        cleanup(request, response, exception);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>preHandle(...)</code>方法默认返回<code>true</code>，其实所有子类过滤器的逻辑应该放在这里面。</li><li><code>executeChain(ServletRequest request, ServletResponse response, FilterChain chain)</code>方法一定要注意，因为这个方法的逻辑是<code>chain.doFilter(request, response)</code>，执行下一个过滤器</li><li><code>postHandle(...)</code>方法默认是一个空方法。</li></ul><p>所有过滤器真正的逻辑应该在<code>preHandle(...)</code>中而不是<code>executeChain(...)</code>中，自定义过滤器重写方法的时候一定要注意。</p><p>看到这你可能会疑惑：真正的前置处理在哪里？其实并没有提供真正意义上的前置处理，为什么这么说呢？看下<code>PathMatchingFilter</code>和<code>AccessControlFilter</code>就知道了。</p><p><strong>PathMatchingFilter类</strong><br>继承自<code>AdviceFilter</code>的<code>PathMatchingFilter</code>中重写的<code>preHandler</code>方法会检查请求路径是否匹配配置，匹配的话则执行<code>isFilterChainContinued()</code>方法，而这个方法中调用了一个抽象方法<code>onPreHandle(...)</code>，源码如下，就不解释了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.appliedPaths == <span class="keyword">null</span> || <span class="keyword">this</span>.appliedPaths.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">            log.trace(<span class="string">"appliedPaths property is null or empty.  This Filter will passthrough immediately."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String path : <span class="keyword">this</span>.appliedPaths.keySet()) &#123;</span><br><span class="line">        <span class="comment">// If the path does match, then pass on to the subclass implementation for specific checks</span></span><br><span class="line">        <span class="comment">//(first match 'wins'):</span></span><br><span class="line">        <span class="keyword">if</span> (pathsMatch(path, request)) &#123;</span><br><span class="line">            log.trace(<span class="string">"Current requestURI matches pattern '&#123;&#125;'.  Determining filter chain execution..."</span>, path);</span><br><span class="line">            Object config = <span class="keyword">this</span>.appliedPaths.get(path);</span><br><span class="line">            <span class="keyword">return</span> isFilterChainContinued(request, response, path, config);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//no path matched, allow the request to go through:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Simple method to abstract out logic from the preHandle implementation - it was getting a bit unruly.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"JavaDoc"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isFilterChainContinued</span><span class="params">(ServletRequest request, ServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       String path, Object pathConfig)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isEnabled(request, response, path, pathConfig)) &#123; <span class="comment">//isEnabled check added in 1.2</span></span><br><span class="line">        <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">            log.trace(<span class="string">"Filter '&#123;&#125;' is enabled for the current request under path '&#123;&#125;' with config [&#123;&#125;].  "</span> +</span><br><span class="line">                    <span class="string">"Delegating to subclass implementation for 'onPreHandle' check."</span>,</span><br><span class="line">                    <span class="keyword">new</span> Object[]&#123;getName(), path, pathConfig&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//The filter is enabled for this specific request, so delegate to subclass implementations</span></span><br><span class="line">        <span class="comment">//so they can decide if the request should continue through the chain or not:</span></span><br><span class="line">        <span class="keyword">return</span> onPreHandle(request, response, pathConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">        log.trace(<span class="string">"Filter '&#123;&#125;' is disabled for the current request under path '&#123;&#125;' with config [&#123;&#125;].  "</span> +</span><br><span class="line">                <span class="string">"The next element in the FilterChain will be called immediately."</span>,</span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;getName(), path, pathConfig&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//This filter is disabled for this specific request,</span></span><br><span class="line">    <span class="comment">//return 'true' immediately to indicate that the filter will not process the request</span></span><br><span class="line">    <span class="comment">//and let the request/response to continue through the filter chain:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AccessControlFilter类</strong><br><code>AccessControlFilter</code>抽象类继承自<code>PathMatchingFilter</code><br><code>AccessControlFilter</code>实现了<code>onPreHandle(...)</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onPreHandle</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> isAccessAllowed(request, response, mappedValue) || onAccessDenied(request, response, mappedValue);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> onAccessDenied(request, response);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure><p>看到这里也就明朗了，返回<code>isAccessAllowed(...) || onAccessDenied(...)</code>，这两个方法都是抽象方法，这个逻辑的意思解释起来就是：先执行<code>isAccessAllowed</code>方法看下能不能访问能访问则直接返回也就是true，如果不能访问，则执行<code>onAccessDenied</code>方法并返回结果（注意理解‘或’运算符）。</p><h3 id="AuthenticationFilter类和AuthenticatingFilter类"><a href="#AuthenticationFilter类和AuthenticatingFilter类" class="headerlink" title="AuthenticationFilter类和AuthenticatingFilter类"></a><code>AuthenticationFilter</code>类和<code>AuthenticatingFilter</code>类</h3><p>注意这两个类名的不同。<br><code>AuthenticationFilter</code>只实现了<code>isAccessAllowed(...)</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 返回绑定到当前线程上的主体是否已经认证的结果</span></span><br><span class="line">    Subject subject = getSubject(request, response);</span><br><span class="line">    <span class="keyword">return</span> subject.isAuthenticated();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而<code>AuthenticatingFilter</code>继承自<code>AuthenticationFilter</code>类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">executeLogin</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    AuthenticationToken token = createToken(request, response);</span><br><span class="line">    <span class="keyword">if</span> (token == <span class="keyword">null</span>) &#123;</span><br><span class="line">        String msg = <span class="string">"createToken method implementation returned null. A valid non-null AuthenticationToken "</span> +</span><br><span class="line">                <span class="string">"must be created in order to execute a login attempt."</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Subject subject = getSubject(request, response);</span><br><span class="line">        subject.login(token);</span><br><span class="line">        <span class="keyword">return</span> onLoginSuccess(token, subject, request, response);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> onLoginFailure(token, e, request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> AuthenticationToken <span class="title">createToken</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.isAccessAllowed(request, response, mappedValue) ||</span><br><span class="line">            (!isLoginRequest(request, response) &amp;&amp; isPermissive(mappedValue));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>解释一下这个<code>isAccessAllowed(...)</code>方法：</p><blockquote><p>The default implementation returns true if the user is authenticated. Will also return true if the isLoginRequest returns false and the “permissive” flag is set<br>如果已经认证则返回true，或者请求不需要认证并且设置了”permissive”，设置”permissive”是什么意思呢：比如说配置过滤器的路由策略时：map.add(“/**”,”authc[permissive]”)</p></blockquote><p>所以这个类其实已经提供了一个通用的逻辑，一般来说，也是能够适应大多数场景下的需求的，所以说，一般我们自定义过滤器就是继承<code>AuthenticatingFilter</code>类，然后只需要重写<code>onAccessDenied(...)</code>方法，在其中调用<code>executeLogin</code>方法进行认证，然后提供创建Token的具体逻辑也就是<code>createToken(..)</code>方法就可以了。</p><p>如果有特殊需求，比如对于Option请求直接放行，那么可以重写<code>isAccessAllowed(...)</code>方法，判断是否是option请求，一般来说我们还是会调用一下父类的通用判断方法：<code>super.isAccessAllowed(...)</code>，后续的案例就用了这种方法实现跨域请求直接放行。</p><p>并且可以看到<code>executeLogin(..)</code>方法中获取<code>Subject</code>并使用<code>createToken</code>方法返回的Token去调用<code>login</code>进行认证，对于认证成功和认证失败还提供了回调处理，我们可以重写这两个方法以满足某些场景下的需求，比如jwt认证成功后判断是否需要刷新token。</p><h2 id="SecurityManager"><a href="#SecurityManager" class="headerlink" title="SecurityManager"></a>SecurityManager</h2><p>当我们使用Subject去调用<code>login(AuthenticationToken)</code>方法时，实际上是委托给<code>DelegatingSubject</code>去处理,而这个类又会从<code>SecurityManager</code>中获取信息再进行处理:</p><p><strong><code>DelegatingSubject#login</code>方法</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    Subject subject = securityManager.login(<span class="keyword">this</span>, token);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>SecurityManager#login</code>方法</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Subject <span class="title">login</span><span class="params">(Subject subject, AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    AuthenticationInfo info;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//调用authenticate方法</span></span><br><span class="line">        info = authenticate(token);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AuthenticationException ae) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            onFailedLogin(token, ae, subject);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">"onFailedLogin method threw an "</span> +</span><br><span class="line">                        <span class="string">"exception.  Logging and propagating original AuthenticationException."</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> ae; <span class="comment">//propagate</span></span><br><span class="line">    &#125;</span><br><span class="line">    Subject loggedIn = createSubject(token, info, subject);</span><br><span class="line">    onSuccessfulLogin(token, info, loggedIn);</span><br><span class="line">    <span class="keyword">return</span> loggedIn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AbstractSecurityManager</code>中有一个<code>Authenticator</code>认证器，在<code>SecurityManager</code>进行认证的时候就是委托它进行认证的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">authenticate</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.authenticator.authenticate(token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Authenticator</code>是一个接口，并且只有一个认证方法，该方法返回认证信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Authenticator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">authenticate</span><span class="params">(AuthenticationToken authenticationToken)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AuthenticationException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>AbstractAuthenticator#authenticate</code></strong>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AuthenticationInfo <span class="title">authenticate</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (token == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Method argument (authentication token) cannot be null."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.trace(<span class="string">"Authentication attempt received for token [&#123;&#125;]"</span>, token);</span><br><span class="line"></span><br><span class="line">    AuthenticationInfo info;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//调用`doAuthenticate(AuthenticationToken)`抽象方法</span></span><br><span class="line">        info = doAuthenticate(token);</span><br><span class="line">        <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</span><br><span class="line">            String msg = <span class="string">"No account information found for authentication token ["</span> + token + <span class="string">"] by this "</span> +</span><br><span class="line">                    <span class="string">"Authenticator instance.  Please check that it is configured correctly."</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        AuthenticationException ae = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> AuthenticationException) &#123;</span><br><span class="line">            ae = (AuthenticationException) t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ae == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//Exception thrown was not an expected AuthenticationException.  Therefore it is probably a little more</span></span><br><span class="line">            <span class="comment">//severe or unexpected.  So, wrap in an AuthenticationException, log to warn, and propagate:</span></span><br><span class="line">            String msg = <span class="string">"Authentication failed for token submission ["</span> + token + <span class="string">"].  Possible unexpected "</span> +</span><br><span class="line">                    <span class="string">"error? (Typical or expected login exceptions should extend from AuthenticationException)."</span>;</span><br><span class="line">            ae = <span class="keyword">new</span> AuthenticationException(msg, t);</span><br><span class="line">            <span class="keyword">if</span> (log.isWarnEnabled())</span><br><span class="line">                log.warn(msg, t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            notifyFailure(token, ae);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t2) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isWarnEnabled()) &#123;</span><br><span class="line">                String msg = <span class="string">"Unable to send notification for failed authentication attempt - listener error?.  "</span> +</span><br><span class="line">                        <span class="string">"Please check your AuthenticationListener implementation(s).  Logging sending exception "</span> +</span><br><span class="line">                        <span class="string">"and propagating original AuthenticationException instead..."</span>;</span><br><span class="line">                log.warn(msg, t2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> ae;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.debug(<span class="string">"Authentication successful for token [&#123;&#125;].  Returned account [&#123;&#125;]"</span>, token, info);</span><br><span class="line"></span><br><span class="line">    notifySuccess(token, info);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该方法调用<code>doAuthenticate(AuthenticationToken)</code>抽象方法，返回认证信息。<br>Shiro中的认证器只有一个实现类：<code>ModularRealmAuthenticator</code></p><p><strong><code>ModularRealmAuthenticator#doAuthenticate</code>方法</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doAuthenticate</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    assertRealmsConfigured();</span><br><span class="line">    Collection&lt;Realm&gt; realms = getRealms();</span><br><span class="line">    <span class="keyword">if</span> (realms.size() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> doSingleRealmAuthentication(realms.iterator().next(), authenticationToken);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> doMultiRealmAuthentication(realms, authenticationToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果只有一个<code>Realm</code>，执行<code>doSingleRealmAuthentication(..)</code>方法<br>否则执行<code>doMultiRealmAuthentication(..)</code>方法</p><p>这两个方法有什么区别呢？</p><p>区别在于第二个方法多了一个认证策略<code>AuthenticationStrategy</code>，有三个实现：</p><ul><li><code>AllSuccessfulStrategy</code>：需要所有的Realm认证通过</li><li><code>AtLeastOneSuccessfulStrategy</code>：至少需要一个Realm认证通过</li><li><code>FirstSuccessfulStrategy</code>：只需要一个Realm认证通过</li></ul><p>最后两个认证策略有什么不同呢？前者在第一个<code>Realm</code>认证成功后还会继续认证剩下的<code>Realm</code>，并把所有的认证信息<code>AuthenticationInfo</code>进行合并。后者在第一个<code>Realm</code>认证成功后直接返回认证信息。默认使用的是<code>AtLeastOneSuccessfulStrategy</code></p><p>来看下<code>doSingleRealmAuthentication(..)</code>和<code>doMultiRealmAuthentication(..)</code>这两个方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doSingleRealmAuthentication</span><span class="params">(Realm realm, AuthenticationToken token)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!realm.supports(token)) &#123;</span><br><span class="line">        String msg = <span class="string">"Realm ["</span> + realm + <span class="string">"] does not support authentication token ["</span> +</span><br><span class="line">                token + <span class="string">"].  Please ensure that the appropriate Realm implementation is "</span> +</span><br><span class="line">                <span class="string">"configured correctly or that the realm accepts AuthenticationTokens of this type."</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedTokenException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    AuthenticationInfo info = realm.getAuthenticationInfo(token);</span><br><span class="line">    <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</span><br><span class="line">        String msg = <span class="string">"Realm ["</span> + realm + <span class="string">"] was unable to find account data for the "</span> +</span><br><span class="line">                <span class="string">"submitted AuthenticationToken ["</span> + token + <span class="string">"]."</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doMultiRealmAuthentication</span><span class="params">(Collection&lt;Realm&gt; realms, AuthenticationToken token)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    AuthenticationStrategy strategy = getAuthenticationStrategy();</span><br><span class="line"></span><br><span class="line">    AuthenticationInfo aggregate = strategy.beforeAllAttempts(realms, token);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">        log.trace(<span class="string">"Iterating through &#123;&#125; realms for PAM authentication"</span>, realms.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Realm realm : realms) &#123;</span><br><span class="line"></span><br><span class="line">        aggregate = strategy.beforeAttempt(realm, token, aggregate);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (realm.supports(token)) &#123;</span><br><span class="line"></span><br><span class="line">            log.trace(<span class="string">"Attempting to authenticate token [&#123;&#125;] using realm [&#123;&#125;]"</span>, token, realm);</span><br><span class="line"></span><br><span class="line">            AuthenticationInfo info = <span class="keyword">null</span>;</span><br><span class="line">            Throwable t = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                info = realm.getAuthenticationInfo(token);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">                t = throwable;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    String msg = <span class="string">"Realm ["</span> + realm + <span class="string">"] threw an exception during a multi-realm authentication attempt:"</span>;</span><br><span class="line">                    log.debug(msg, t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            aggregate = strategy.afterAttempt(realm, token, info, aggregate, t);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.debug(<span class="string">"Realm [&#123;&#125;] does not support token &#123;&#125;.  Skipping realm."</span>, realm, token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    aggregate = strategy.afterAllAttempts(token, aggregate);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> aggregate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>doSingleRealmAuthentication(..)</code>方法不需要解释。<br><code>doMultiRealmAuthentication(..)</code>方法大体就是便利所有的<code>Realm</code>，如果这个<code>Realm</code>支持当前这个Token，则调用<code>getAuthenticationInfo(AuthenticationToken)</code>方法获取认证信息，然后根据使用的认证策略去处理认证信息。</p><p>而<code>getAuthenticationInfo(AuthenticationToken)</code>方法很简单：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AuthenticationInfo <span class="title">getAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line"></span><br><span class="line">    AuthenticationInfo info = getCachedAuthenticationInfo(token);</span><br><span class="line">    <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//otherwise not cached, perform the lookup:</span></span><br><span class="line">        info = doGetAuthenticationInfo(token);</span><br><span class="line">        log.debug(<span class="string">"Looked up AuthenticationInfo [&#123;&#125;] from doGetAuthenticationInfo"</span>, info);</span><br><span class="line">        <span class="keyword">if</span> (token != <span class="keyword">null</span> &amp;&amp; info != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cacheAuthenticationInfoIfPossible(token, info);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.debug(<span class="string">"Using cached authentication info [&#123;&#125;] to perform credentials matching."</span>, info);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</span><br><span class="line">        assertCredentialsMatch(token, info);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.debug(<span class="string">"No AuthenticationInfo found for submitted AuthenticationToken [&#123;&#125;].  Returning null."</span>, token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先从缓存中取，如果缓存里没有则调用<code>doGetAuthenticationInfo(AuthenticationToken)</code>方法获取（我们实现自己的Realm时一般就要实现这个方法，这个是获取认证信息的方法，还有一个获取权限信息的方法）<br>最后，如果info不为<code>null</code>，调用<code>assertCredentialsMatch(..)</code>方法判断token和info是否匹配。默认使用的<code>CredentialsMatcher</code>是<code>SimpleCredentialsMatcher</code>，即调用<code>AuthenticationToken</code>和<code>AuthenticationInfo</code>的<code>getCredentials()</code>后进行简单的equal匹配。</p><h2 id="一个前后端分离案例"><a href="#一个前后端分离案例" class="headerlink" title="一个前后端分离案例"></a>一个前后端分离案例</h2><p><strong>JWTToken</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTToken</span> <span class="keyword">implements</span> <span class="title">HostAuthenticationToken</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> JWTToken NONE = <span class="keyword">new</span> JWTToken(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String token;</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JWTToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(token, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JWTToken</span><span class="params">(String token, String host)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.token = token;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.token;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> host;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getPrincipal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getCredentials</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"JWTToken&#123;"</span> +</span><br><span class="line">                <span class="string">"token='"</span> + token + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", host='"</span> + host + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>JwtHttpAuthenticationFilter</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> me.lolico.blog.web.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.lolico.blog.web.JWTToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.authc.AuthenticatingFilter;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lolico</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtHttpAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">AuthenticatingFilter</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This class's private logger.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(JwtHttpAuthenticationFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HTTP Authorization header, equal to &lt;code&gt;Authorization&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORIZATION_HEADER = <span class="string">"Authorization"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HTTP Authentication header, equal to &lt;code&gt;WWW-Authenticate&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHENTICATE_HEADER = <span class="string">"WWW-Authenticate"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The authzScheme default value to look for in the &lt;code&gt;Authorization&lt;/code&gt; header</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_AUTHORIZATION_SCHEME = <span class="string">"Bearer"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name that is displayed during the challenge process of authentication, defauls to &lt;code&gt;application&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * and can be overridden by the &#123;<span class="doctag">@link</span> #setApplicationName(String) setApplicationName&#125; method.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String applicationName = <span class="string">"application"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The authzScheme value to look for in the &lt;code&gt;Authorization&lt;/code&gt; header, defaults to &lt;code&gt;Bearer&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * Can override by &#123;<span class="doctag">@link</span> #setAuthzScheme(String)&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String authzScheme = DEFAULT_AUTHORIZATION_SCHEME;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;true&lt;/code&gt; will enable "OPTION" request method, &lt;code&gt;false&lt;/code&gt; otherwise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isCorsEnable = <span class="keyword">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * the callback handler for successful authentication</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> SuccessfulHandler successfulHandler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * the callback handler for unsuccessful authentication</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> UnsuccessfulHandler unsuccessfulHandler;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtHttpAuthenticationFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        unsuccessfulHandler = (token, e, request, response) -&gt; &#123;</span><br><span class="line">            <span class="comment">//defaults to set 401-unauthorized http status</span></span><br><span class="line">            HttpServletResponse httpResponse = ((HttpServletResponse) response);</span><br><span class="line">            String authcHeader = getAuthzScheme() + <span class="string">" realm=\""</span> + getApplicationName() + <span class="string">"\""</span>;</span><br><span class="line">            httpResponse.setHeader(AUTHENTICATE_HEADER, authcHeader);</span><br><span class="line">            httpResponse.setStatus(HttpServletResponse.SC_UNAUTHORIZED);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtHttpAuthenticationFilter</span><span class="params">(String authzScheme, <span class="keyword">boolean</span> isCorsEnable, SuccessfulHandler successfulHandler, UnsuccessfulHandler unsuccessfulHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.authzScheme = authzScheme;</span><br><span class="line">        <span class="keyword">this</span>.isCorsEnable = isCorsEnable;</span><br><span class="line">        <span class="keyword">this</span>.successfulHandler = successfulHandler;</span><br><span class="line">        <span class="keyword">this</span>.unsuccessfulHandler = unsuccessfulHandler;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the name that is displayed during the challenge process of authentication</span></span><br><span class="line"><span class="comment">     * Default value is &lt;code&gt;application&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the name that is displayed during the challenge process of authentication</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getApplicationName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> applicationName;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the name that is displayed during the challenge process of authentication</span></span><br><span class="line"><span class="comment">     * Default value is &lt;code&gt;application&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> applicationName the name that is displayed during the challenge process of authentication</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationName</span><span class="params">(String applicationName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationName = applicationName;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the HTTP &lt;b&gt;&lt;code&gt;Authorization&lt;/code&gt;&lt;/b&gt; header value that this filter will respond to as indicating</span></span><br><span class="line"><span class="comment">     * a login request.</span></span><br><span class="line"><span class="comment">     * &lt;p/&gt;</span></span><br><span class="line"><span class="comment">     * Unless overridden by the &#123;<span class="doctag">@link</span> #setAuthzScheme(String)&#125; method, the</span></span><br><span class="line"><span class="comment">     * default value is &lt;code&gt;Bearer&lt;/code&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the Http 'Authorization' header value that this filter will respond to as indicating a login request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAuthzScheme</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> authzScheme;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the HTTP &lt;b&gt;&lt;code&gt;Authorization&lt;/code&gt;&lt;/b&gt; header value that this filter will respond to as indicating a</span></span><br><span class="line"><span class="comment">     * login request.</span></span><br><span class="line"><span class="comment">     * &lt;p/&gt;</span></span><br><span class="line"><span class="comment">     * Unless overridden by this method, the default value is &lt;code&gt;Bearer&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authzScheme the HTTP &lt;code&gt;Authorization&lt;/code&gt; header value that this filter will respond to as</span></span><br><span class="line"><span class="comment">     *                    indicating a login request.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuthzScheme</span><span class="params">(String authzScheme)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.authzScheme = authzScheme;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Default value is &lt;code&gt;true&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> corsEnable &lt;code&gt;true&lt;/code&gt; will enable "OPTION" request method, &lt;code&gt;false&lt;/code&gt; otherwise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCorsEnable</span><span class="params">(<span class="keyword">boolean</span> corsEnable)</span> </span>&#123;</span><br><span class="line">        isCorsEnable = corsEnable;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Default value is &lt;code&gt;true&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> is cors enable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCorsEnable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isCorsEnable;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the callback handler for successful authentication</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the callback handler for successful authentication</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SuccessfulHandler <span class="title">getSuccessfulHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> successfulHandler;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> successfulHandler the callback handler for successful authentication</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSuccessfulHandler</span><span class="params">(SuccessfulHandler successfulHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.successfulHandler = successfulHandler;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the callback handler for unsuccessful authentication</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the callback handler for unsuccessful authentication</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UnsuccessfulHandler <span class="title">getUnsuccessfulHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unsuccessfulHandler;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unsuccessfulHandler the callback handler for successful authentication</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUnsuccessfulHandler</span><span class="params">(UnsuccessfulHandler unsuccessfulHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.unsuccessfulHandler = unsuccessfulHandler;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The Basic authentication filter can be configured with a list of HTTP methods to which it should apply. This</span></span><br><span class="line"><span class="comment">     * method ensures that authentication is &lt;em&gt;only&lt;/em&gt; required for those HTTP methods specified. For example,</span></span><br><span class="line"><span class="comment">     * if you had the configuration:</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     *      [urls]</span></span><br><span class="line"><span class="comment">     *      /basic/** = authcJwt[POST,PUT,DELETE]</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     * then a GET request would not required authentication but a POST would.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request     The current HTTP servlet request.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response    The current HTTP servlet response.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mappedValue The array of configured HTTP methods as strings. This is empty if no methods are configured.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> </span>&#123;</span><br><span class="line">        HttpServletRequest httpRequest = ((HttpServletRequest) request);</span><br><span class="line">        String httpMethod = httpRequest.getMethod();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check whether the current request's method requires authentication.</span></span><br><span class="line">        <span class="comment">// If no methods have been configured, then all of them require auth,</span></span><br><span class="line">        <span class="comment">// otherwise only the declared ones need authentication.</span></span><br><span class="line">        </span><br><span class="line">        Set&lt;String&gt; methods = httpMethodsFromOptions((String[]) mappedValue);</span><br><span class="line">        <span class="keyword">boolean</span> authcRequired = methods.size() == <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// If enable cors and this request_method is equal to "OPTION", do not authentication.</span></span><br><span class="line">        <span class="comment">// Can override by configuration:</span></span><br><span class="line">        <span class="comment">// /** = authcJwt[POST,DELETE,OPTION]</span></span><br><span class="line">        <span class="comment">// then a OPTION request would required authentication.</span></span><br><span class="line">        <span class="comment">// if (isCorsEnable &amp;&amp; httpMethod.equalsIgnoreCase("OPTION")) &#123;</span></span><br><span class="line">        <span class="comment">//     authcRequired = false;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="keyword">for</span> (String m : methods) &#123;</span><br><span class="line">            <span class="keyword">if</span> (httpMethod.toUpperCase(Locale.ENGLISH).equals(m)) &#123; <span class="comment">// list of methods is in upper case</span></span><br><span class="line">                authcRequired = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// if (isCorsEnable &amp;&amp; httpMethod.equalsIgnoreCase("OPTION")) &#123;</span></span><br><span class="line">        <span class="comment">//     responseForCors(request, response);</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (authcRequired) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.isAccessAllowed(request, response, mappedValue);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cors support</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isCorsEnable() &amp;&amp; ((HttpServletRequest) request).getMethod().equals(<span class="string">"OPTIONS"</span>)) &#123;</span><br><span class="line">            responseForCors(request, response);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.preHandle(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">responseForCors</span><span class="params">(ServletRequest request, ServletResponse response)</span> </span>&#123;</span><br><span class="line">        HttpServletRequest httpRequest = (HttpServletRequest) request;</span><br><span class="line">        HttpServletResponse httpResponse = (HttpServletResponse) response;</span><br><span class="line">        </span><br><span class="line">        httpResponse.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>, httpRequest.getHeader(<span class="string">"Origin"</span>));</span><br><span class="line">        httpResponse.setHeader(<span class="string">"Access-Control-Allow-Headers"</span>, httpRequest.getHeader(<span class="string">"Access-Control-Allow-Headers"</span>));</span><br><span class="line">        httpResponse.setHeader(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"GET,POST,PUT,DELETE,OPTIONS"</span>);</span><br><span class="line">        httpResponse.setHeader(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>);</span><br><span class="line">        </span><br><span class="line">        httpResponse.setStatus(HttpServletResponse.SC_OK);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">httpMethodsFromOptions</span><span class="params">(String[] options)</span> </span>&#123;</span><br><span class="line">        Set&lt;String&gt; methods = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String option : options) &#123;</span><br><span class="line">                <span class="comment">// to be backwards compatible with 1.3, we can ONLY check for known args</span></span><br><span class="line">                <span class="comment">// ideally we would just validate HTTP methods, but someone could already be using this for webdav</span></span><br><span class="line">                <span class="keyword">if</span> (!option.equalsIgnoreCase(PERMISSIVE)) &#123;</span><br><span class="line">                    methods.add(option.toUpperCase(Locale.ENGLISH));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> methods;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Processes unauthenticated requests. It handles the two-stage request/challenge authentication protocol.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request  incoming ServletRequest</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response outgoing ServletResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if the request should be processed; false if the request should not continue to be processed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> loggedIn = <span class="keyword">false</span>; <span class="comment">//false by default or we wouldn't be in this method</span></span><br><span class="line">        <span class="keyword">if</span> (isLoginRequest(request, response)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"Attempting to execute login with auth header"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            loggedIn = executeLogin(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> loggedIn;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns &lt;code&gt;true&lt;/code&gt; if the incoming request have &#123;<span class="doctag">@link</span> #getAuthzHeader(ServletRequest)&#125;</span></span><br><span class="line"><span class="comment">     * and the header's value is start with &#123;<span class="doctag">@link</span> #getAuthzScheme()&#125;, &lt;code&gt;false&lt;/code&gt; otherwise.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request  the incoming &lt;code&gt;ServletRequest&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response the outgoing &lt;code&gt;ServletResponse&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &lt;code&gt;true&lt;/code&gt; if the incoming request is required auth, &lt;code&gt;false&lt;/code&gt; otherwise.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isLoginRequest</span><span class="params">(ServletRequest request, ServletResponse response)</span> </span>&#123;</span><br><span class="line">        String authzHeader = getAuthzHeader(request);</span><br><span class="line">        String scheme = getAuthzScheme().toLowerCase(Locale.ENGLISH);</span><br><span class="line">        <span class="keyword">return</span> authzHeader != <span class="keyword">null</span> &amp;&amp; authzHeader.toLowerCase(Locale.ENGLISH).startsWith(scheme);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request the incoming &lt;code&gt;ServletRequest&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the &lt;code&gt;Authorization&lt;/code&gt; header's value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getAuthzHeader</span><span class="params">(ServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ((HttpServletRequest) request).getHeader(AUTHORIZATION_HEADER);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the authentication token encapsulated by the value of the Authorization header</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request  the incoming &lt;code&gt;ServletRequest&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response the outgoing &lt;code&gt;ServletResponse&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the authentication token encapsulated by the value of the Authorization header</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationToken <span class="title">createToken</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String authzHeader = getAuthzHeader(request);</span><br><span class="line">        <span class="keyword">if</span> (authzHeader == <span class="keyword">null</span> || authzHeader.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> JWTToken.NONE;</span><br><span class="line">        &#125;</span><br><span class="line">        String scheme = getAuthzScheme();</span><br><span class="line">        <span class="keyword">if</span> (scheme != <span class="keyword">null</span> &amp;&amp; scheme.length() != <span class="number">0</span>) &#123;</span><br><span class="line">            authzHeader = authzHeader.substring(scheme.length());</span><br><span class="line">        &#125;</span><br><span class="line">        String token = authzHeader.trim();</span><br><span class="line">        String host = request.getRemoteHost();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JWTToken(token, host);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Callback processing after authentication successful.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onLoginSuccess</span><span class="params">(AuthenticationToken token, Subject subject, ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (successfulHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"&#123;&#125; can pass auth, the auth subject is &#123;&#125;"</span>, token, subject);</span><br><span class="line">            &#125;</span><br><span class="line">            successfulHandler.onSuccessful(token, subject, request, response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Callback processing after authentication failure.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">onLoginFailure</span><span class="params">(AuthenticationToken token, AuthenticationException e, ServletRequest request, ServletResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (unsuccessfulHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"&#123;&#125; can not pass auth, the auth exception message is &#123;&#125;"</span>, token, e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">            unsuccessfulHandler.onUnsuccessful(token, e, request, response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UnsuccessfulHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Callback processing when auth successful</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token    the token can not pass authentication</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e        the exception thrown during authentication</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request  the incoming &lt;code&gt;ServletRequest&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response the outgoing &lt;code&gt;ServletResponse&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onUnsuccessful</span><span class="params">(AuthenticationToken token, AuthenticationException e, ServletRequest request, ServletResponse response)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SuccessfulHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Callback processing when auth unsuccessful</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token    the token can pass authentication</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subject  the incoming auth &lt;code&gt;Subject&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request  the incoming &lt;code&gt;ServletRequest&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response the outgoing &lt;code&gt;ServletResponse&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onSuccessful</span><span class="params">(AuthenticationToken token, Subject subject, ServletRequest request, ServletResponse response)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>JwtRealm</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        String jwt = ((JWTToken) token).getToken();</span><br><span class="line">        <span class="keyword">boolean</span> authResult = JwtUtils.verifyToken(jwt);</span><br><span class="line">        <span class="keyword">if</span> (!authResult) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IncorrectCredentialsException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(jwt, jwt, getName());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(AuthenticationToken token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> token <span class="keyword">instanceof</span> JWTToken;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>JwtUtils</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtUtils</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String issuer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String secret;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Duration lifeTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SignatureAlgorithm algorithm;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(SecurityProperties securityProperties)</span> </span>&#123;</span><br><span class="line">        SecurityProperties.JWT jwt = securityProperties.getJwt();</span><br><span class="line">        JwtUtils.issuer = jwt.getIss();</span><br><span class="line">        JwtUtils.secret = jwt.getSecret();</span><br><span class="line">        JwtUtils.lifeTime = jwt.getLifeTime();</span><br><span class="line">        JwtUtils.algorithm = jwt.getAlg();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createToken</span><span class="params">(String subject)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; claims = Collections.emptyMap();</span><br><span class="line">        <span class="keyword">return</span> doCreateToken(subject, claims, lifeTime);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createToken</span><span class="params">(String subject, Consumer&lt;Map&lt;String, Object&gt;&gt; consumer)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; claims = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        consumer.accept(claims);</span><br><span class="line">        <span class="keyword">return</span> doCreateToken(subject, claims, lifeTime);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createToken</span><span class="params">(String subject, Map&lt;String, Object&gt; claims)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createToken(subject, map -&gt; map.putAll(claims));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createToken</span><span class="params">(String subject, Map&lt;String, Object&gt; claims, <span class="keyword">long</span> expiration, ChronoUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> doCreateToken(subject, claims, Duration.of(expiration, unit));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">doCreateToken</span><span class="params">(String subject, Map&lt;String, Object&gt; claims, Duration expiration)</span> </span>&#123;</span><br><span class="line">        Instant now = Instant.now();</span><br><span class="line">        JwtBuilder builder = Jwts.builder()</span><br><span class="line">                .setHeaderParam(Header.TYPE, Header.JWT_TYPE) <span class="comment">//添加令牌类型</span></span><br><span class="line">                .addClaims(claims) <span class="comment">//添加自定义Claims</span></span><br><span class="line">                .setSubject(subject) <span class="comment">//接受人</span></span><br><span class="line">                .setIssuedAt(Date.from(now)) <span class="comment">//签发时间</span></span><br><span class="line">                .signWith(algorithm, secret);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(issuer)) &#123;</span><br><span class="line">            builder.setIssuer(issuer); <span class="comment">//签发人</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (expiration != <span class="keyword">null</span> &amp;&amp; expiration.isNegative()) &#123;</span><br><span class="line">            builder.setExpiration(Date.from(now.plus(expiration))); <span class="comment">//过期时间</span></span><br><span class="line">        &#125;</span><br><span class="line">        String token = builder.compact();</span><br><span class="line">        <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">            log.trace(<span class="string">"Create token[&#123;&#125;] in &#123;&#125;"</span>, token, Date.from(now));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Claims <span class="title">getClaims</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        Claims body;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            body = Jwts.parser()</span><br><span class="line">                    .setSigningKey(secret)</span><br><span class="line">                    .parseClaimsJws(token)</span><br><span class="line">                    .getBody();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExpiredJwtException e) &#123;</span><br><span class="line">            <span class="comment">// ignoring expired token exception</span></span><br><span class="line">            body = e.getClaims();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"An exception[&#123;&#125;] occurred during get claims"</span>, e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">            body = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> body;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">verifyToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//noinspection rawtypes</span></span><br><span class="line">        Jwt jwt;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jwt = parseToken(token);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"Token[&#123;&#125;] verify failed, message: &#123;&#125;"</span>, token, e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Claims claims = (Claims) jwt.getBody();</span><br><span class="line">        String issuer = claims.getIssuer();</span><br><span class="line">        <span class="keyword">if</span> (issuer != <span class="keyword">null</span> &amp;&amp; !issuer.equals(JwtUtils.issuer)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                String msg = <span class="string">"Incorrect issuer: "</span> + issuer;</span><br><span class="line">                log.debug(<span class="string">"Token[&#123;&#125;] verify failed, message: &#123;&#125;"</span>, token, msg);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String subject = claims.getSubject();</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(subject)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                String msg = <span class="string">"subject cannot be null or empty"</span>;</span><br><span class="line">                log.debug(<span class="string">"Token[&#123;&#125;] verify failed, message: &#123;&#125;"</span>, token, msg);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> JwtParser#parse(String)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Jwt <span class="title">parseToken</span><span class="params">(String token)</span> <span class="keyword">throws</span> ExpiredJwtException, MalformedJwtException, SignatureException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Jwts.parser()</span><br><span class="line">                .setSigningKey(secret)</span><br><span class="line">                .parse(token);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isValidToken</span><span class="params">(String token, String subject)</span> </span>&#123;</span><br><span class="line">        Optional&lt;String&gt; username = getClaimFromToken(token, Claims::getSubject);</span><br><span class="line">        <span class="keyword">return</span> username.filter(s -&gt; (s.equals(subject) &amp;&amp; !isTokenExpired(token))).isPresent();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isTokenExpired</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        Optional&lt;Date&gt; expiration = getClaimFromToken(token, Claims::getExpiration);</span><br><span class="line">        <span class="keyword">return</span> expiration.map(date -&gt; date.before(<span class="keyword">new</span> Date())).orElse(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Optional&lt;T&gt; <span class="title">getClaimFromToken</span><span class="params">(String token, Function&lt;Claims, T&gt; resolver)</span> </span>&#123;</span><br><span class="line">        Claims claims = getClaims(token);</span><br><span class="line">        <span class="keyword">if</span> (claims == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"Cannot operate on a null Claims"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Optional.empty();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Optional.ofNullable(resolver.apply(claims));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ShiroConfig</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(SecurityProperties<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnProperty</span>(<span class="title">name</span> </span>= <span class="string">"me.lolico.blog.security.enable"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityManager <span class="title">securityManager</span><span class="params">(Collection&lt;Realm&gt; realms)</span> </span>&#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager(realms);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 关闭shiro自带的session</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        DefaultSubjectDAO subjectDAO = <span class="keyword">new</span> DefaultSubjectDAO();</span><br><span class="line">        DefaultSessionStorageEvaluator defaultSessionStorageEvaluator = <span class="keyword">new</span> DefaultSessionStorageEvaluator();</span><br><span class="line">        defaultSessionStorageEvaluator.setSessionStorageEnabled(<span class="keyword">false</span>);</span><br><span class="line">        subjectDAO.setSessionStorageEvaluator(defaultSessionStorageEvaluator);</span><br><span class="line">        securityManager.setSubjectDAO(subjectDAO);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//认证器</span></span><br><span class="line">        ModularRealmAuthenticator authenticator = <span class="keyword">new</span> ModularRealmAuthenticator();</span><br><span class="line">        authenticator.setRealms(realms);</span><br><span class="line">        <span class="comment">//认证策略</span></span><br><span class="line">        authenticator.setAuthenticationStrategy(<span class="keyword">new</span> FirstSuccessfulStrategy());</span><br><span class="line">        securityManager.setAuthenticator(authenticator);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shiroFilterFactoryBean</span><span class="params">(SecurityManager securityManager)</span> </span>&#123;</span><br><span class="line">        ShiroFilterFactoryBean factoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">        factoryBean.setSecurityManager(securityManager);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 自定义过滤器</span></span><br><span class="line">        Map&lt;String, Filter&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"auth"</span>, <span class="keyword">new</span> JwtHttpAuthenticationFilter());</span><br><span class="line">        factoryBean.setFilters(map);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 自定义路由策略</span></span><br><span class="line">        Map&lt;String, String&gt; definitionMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        definitionMap.put(<span class="string">"/login"</span>, <span class="string">"anon"</span>);</span><br><span class="line">        definitionMap.put(<span class="string">"/register"</span>, <span class="string">"anon"</span>);</span><br><span class="line">        definitionMap.put(<span class="string">"/u/confirm/**"</span>, <span class="string">"anon"</span>);</span><br><span class="line">        definitionMap.put(<span class="string">"/**"</span>, <span class="string">"auth"</span>);</span><br><span class="line">        factoryBean.setFilterChainDefinitionMap(definitionMap);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> factoryBean;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A &#123;<span class="doctag">@code</span> credentialsMatcher&#125;,</span></span><br><span class="line"><span class="comment">     * using SHA256 algorithm and iteration three times</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a credentialsMatcher</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CredentialsMatcher <span class="title">hashedCredentialsMatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HashedCredentialsMatcher credentialsMatcher = <span class="keyword">new</span> HashedCredentialsMatcher();</span><br><span class="line">        credentialsMatcher.setHashAlgorithmName(Sha256Hash.ALGORITHM_NAME);</span><br><span class="line">        credentialsMatcher.setHashIterations(Constant.security.ITERATIONS);</span><br><span class="line">        credentialsMatcher.setStoredCredentialsHexEncoded(Constant.security.TO_HEX);</span><br><span class="line">        <span class="keyword">return</span> credentialsMatcher;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Annotation support</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@DependsOn</span>(<span class="string">"lifecycleBeanPostProcessor"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title">defaultAdvisorAutoProxyCreator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultAdvisorAutoProxyCreator defaultAdvisorAutoProxyCreator = <span class="keyword">new</span> DefaultAdvisorAutoProxyCreator();</span><br><span class="line">        <span class="comment">// 强制使用cglib，防止重复代理和可能引起代理出错的问题</span></span><br><span class="line">        <span class="comment">// https://zhuanlan.zhihu.com/p/29161098</span></span><br><span class="line">        defaultAdvisorAutoProxyCreator.setProxyTargetClass(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultAdvisorAutoProxyCreator;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LifecycleBeanPostProcessor <span class="title">lifecycleBeanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LifecycleBeanPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">authorizationAttributeSourceAdvisor</span><span class="params">(SecurityManager securityManager)</span> </span>&#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor advisor = <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        advisor.setSecurityManager(securityManager);</span><br><span class="line">        <span class="keyword">return</span> advisor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>JwtRealm#doGetAuthorizationInfo</code>获取权限可以从token中解析然后返回，注意在生成token的时候要放到Claims中</li><li><code>JwtAuthenticationFilter#isAccessAllowed</code>方法中注释的部分和<code>JwtAuthenticationFilter#preHandle</code>方法是支持cors的两种方式。</li></ul><p>至于其他地方，应该不难理解。</p><h2 id="后语"><a href="#后语" class="headerlink" title="后语"></a>后语</h2><p>Shiro的认证流程到现在，那么也就分析完了。从Shiro的<code>Filter</code>到<code>SecurityManager</code>再到前后端分离案例，其实一路看下来，Shiro框架的代码是十分优雅并且简单易用的。</p><p><em>文章中代码较多。如有任何错误，还请指出，谢谢。</em></p></div><blockquote class="post-copyright"><div class="content"><span class="post-time">最后更新时间：<time datetime="2022-02-17T12:36:57.927Z" itemprop="dateUpdated">2022-02-17 20:36:57</time></span><br>转载注明出处：<a href="/2020/02/04/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Shiro%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8A%E4%B8%80%E4%B8%AA%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%A1%88%E4%BE%8B/" rel="external">https://lolico.me/2020/02/04/源码角度分析Shiro认证流程以及一个前后端分离案例/</a></div><footer><a href="https://lolico.me"><img src="/img/avatar.jpg" alt="mmmmx"> mmmmx</a></footer></blockquote><div class="page-reward"><a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a></div><div class="post-footer"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/" rel="tag">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Shiro/" rel="tag">Shiro</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul><div class="page-share-wrap"><div class="page-share" id="pageShare"><ul class="reset share-icons"><li><a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://lolico.me/2020/02/04/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Shiro%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8A%E4%B8%80%E4%B8%AA%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%A1%88%E4%BE%8B/&title=《源码角度分析Shiro认证流程以及一个前后端分离案例》 — &pic=https://lolico.me/img/avatar.jpg" data-title="微博"><i class="icon icon-weibo"></i></a></li><li><a class="weixin share-sns wxFab" href="javascript:;" data-title="微信"><i class="icon icon-weixin"></i></a></li><li><a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://lolico.me/2020/02/04/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Shiro%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8A%E4%B8%80%E4%B8%AA%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%A1%88%E4%BE%8B/&title=《源码角度分析Shiro认证流程以及一个前后端分离案例》 — &source=萌面喵喵侠的个人博客" data-title=" QQ"><i class="icon icon-qq"></i></a></li><li><a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://lolico.me/2020/02/04/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Shiro%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8A%E4%B8%80%E4%B8%AA%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%A1%88%E4%BE%8B/" data-title=" Facebook"><i class="icon icon-facebook"></i></a></li><li><a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《源码角度分析Shiro认证流程以及一个前后端分离案例》 — &url=https://lolico.me/2020/02/04/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Shiro%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8A%E4%B8%80%E4%B8%AA%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%A1%88%E4%BE%8B/&via=https://lolico.me" data-title=" Twitter"><i class="icon icon-twitter"></i></a></li><li><a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://lolico.me/2020/02/04/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Shiro%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8A%E4%B8%80%E4%B8%AA%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%A1%88%E4%BE%8B/" data-title=" Google+"><i class="icon icon-google-plus"></i></a></li></ul></div><a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle"><i class="icon icon-share-alt icon-lg"></i></a></div></div></div><nav class="post-nav flex-row flex-justify-between"><div class="waves-block waves-effect prev"><a href="/2020/03/02/hello-world/" id="post-prev" class="post-nav-link"><div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div><h4 class="title">Hello World</h4></a></div><div class="waves-block waves-effect next"><a href="/2020/02/04/Shiro%E7%AE%80%E4%BB%8B/" id="post-next" class="post-nav-link"><div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div><h4 class="title">Shiro简介</h4></a></div></nav><section class="comments" id="comments"><div id="gitalk-container"></div><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>const gitalk=new Gitalk({clientID:"0f06d8c6e963192695db",clientSecret:"59650bb92bb41ad1bc07668bf4fab39ffeb785d9",repo:"c3b2a7.github.io",owner:"c3b2a7",admin:["c3b2a7"],id:"2020-02-04 18:50:51",title:document.title,distractionFreeMode:!1});gitalk.render("gitalk-container")</script></section></article><div id="reward" class="page-modal reward-lay"><a class="close" href="javascript:;"><i class="icon icon-close"></i></a><h3 class="reward-title"><i class="icon icon-quote-left"></i> 感谢投食~ <i class="icon icon-quote-right"></i></h3><div class="reward-content"><div class="reward-code"><img id="rewardCode" src="/img/wechat.jpg" alt="打赏二维码"></div><label class="reward-toggle"><input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/wechat.jpg" data-alipay="/img/alipay.jpg"><div class="reward-toggle-ctrol"><span class="reward-toggle-item wechat">微信</span> <span class="reward-toggle-label"></span> <span class="reward-toggle-item alipay">支付宝</span></div></label></div></div></div><footer class="footer"><div class="top"><p><span id="busuanzi_container_site_uv" style="display:none">站点总访客数：<span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" style="display:none">站点总访问量：<span id="busuanzi_value_site_pv"></span></span></p><p><span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span> <span>博客内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span></p></div><div class="bottom"><p><span>mmmmx &copy; 2018 - 2022</span> <span><a href="http://www.miitbeian.gov.cn/" target="_blank">赣ICP备18010727号</a><br>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></span></p></div></footer></main><div class="mask" id="mask"></div><a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a><div class="global-share" id="globalShare"><ul class="reset share-icons"><li><a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://lolico.me/2020/02/04/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Shiro%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8A%E4%B8%80%E4%B8%AA%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%A1%88%E4%BE%8B/&title=《源码角度分析Shiro认证流程以及一个前后端分离案例》 — &pic=https://lolico.me/img/avatar.jpg" data-title="微博"><i class="icon icon-weibo"></i></a></li><li><a class="weixin share-sns wxFab" href="javascript:;" data-title="微信"><i class="icon icon-weixin"></i></a></li><li><a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://lolico.me/2020/02/04/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Shiro%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8A%E4%B8%80%E4%B8%AA%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%A1%88%E4%BE%8B/&title=《源码角度分析Shiro认证流程以及一个前后端分离案例》 — &source=萌面喵喵侠的个人博客" data-title=" QQ"><i class="icon icon-qq"></i></a></li><li><a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://lolico.me/2020/02/04/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Shiro%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8A%E4%B8%80%E4%B8%AA%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%A1%88%E4%BE%8B/" data-title=" Facebook"><i class="icon icon-facebook"></i></a></li><li><a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《源码角度分析Shiro认证流程以及一个前后端分离案例》 — &url=https://lolico.me/2020/02/04/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Shiro%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8A%E4%B8%80%E4%B8%AA%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%A1%88%E4%BE%8B/&via=https://lolico.me" data-title=" Twitter"><i class="icon icon-twitter"></i></a></li><li><a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://lolico.me/2020/02/04/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Shiro%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8A%E4%B8%80%E4%B8%AA%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%A1%88%E4%BE%8B/" data-title=" Google+"><i class="icon icon-google-plus"></i></a></li></ul></div><div class="page-modal wx-share" id="wxShare"><a class="close" href="javascript:;"><i class="icon icon-close"></i></a><p>扫一扫，分享到微信</p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAW4AAAFuCAAAAACEya1TAAAGvElEQVR42u3dQW4bSRAEQP3/015gTwtIpDKzRt6DgieCFofd0X0oZBXgj4/49eff1/t//fw3+SefX/ka/vt58r59Zv7JYy/cuHHjxo37F3P/eftqmd4vKyHIN58c0vuV5N9K9hWtCjdu3Lhx48YdcOcFVoKYH0NeRF4OJkFsr8JYaOLGjRs3bty4H+Jul3j51haBbUnRxoobN27cuHHj/n+52wKrbaq1kVNb2OUtwLZZiBs3bty4ceN+ljtpnuWvewjVPq29Fhe+1gc3bty4cePGnXO3TSnv7wEZbty4vceNG3ceJ7Wl3tb6SsKpvIF3GXRuI7NRDDdu3Lhx48YdJCeXZtXWTrsHWFGb6nAh8oIvj7dw48aNGzdu3Dl33rLa2mD3RlRyRbYicruCeVsON27cuHHjxp38TT6AkhdPeVGVb/vvxEzJFXwsnMKNGzdu3Lhxv+DeyrK2FEtKwLZoay9KG8bdZ6Zw48aNGzdu3FtmcmlH3YOnNvy6x0+XovOBiAo3bty4cePGXTbP2nJti5PazW+F2j2QyuO5b34RN27cuHHjxv3iFzeyLRi6j+y03NsKt4Gn95+cbihu3Lhx48b9a7iTgqltgOXfStbQtsHa69I28JJysIixcOPGjRs3btxvw6lkM1vJ1cY9F5r20my7fi/wxY5w48aNGzdu3BN3Oy6Tj/LkxNv79sDyoKotYXHjxo0bN27cG/elGda2mtpBoi0suxRzxTxUHMmN54YbN27cuHH/Mu47bk7fxkBJAZcfz2VAJ4nk2iYibty4cePGjTvh3tpUH8ErOcI8fmpLzHxt7fG0rT7cuHHjxo0b9yufLR7ahnvacOpeUJ5io+Dv6wIXN27cuHHjxr10kU6v+yBOEoflT9hace37MQvEjRs3bty4cR+CmHYA6Ce23QZVW9GZl7xF+YsbN27cuHHj7kxOm7kcQLLcy6/cP783AnHjxo0bN27c+dMuQ7f5yEtbLF5uTVv2tWFZW/Lixo0bN27cuN//bhsS5cO17cbyoaIL+r3Ua8ebXg4c48aNGzdu3Lhf/NZTw7tteZTwbaXbNpqzXbh8Jbhx48aNGzfunPsjfrVjMVvb6VLqteVmXti1Smv7Ejdu3Lhx4/6N3El77KmIZ9v2pS2XN+EuV6do9eHGjRs3bty4gyolL6EeqDrLrW5Dz/lh/3QQVtDgxo0bN27cv577UpAlrD8H1+Led92u54sn4MaNGzdu3LgP3PeW1TZA3K4kj8aSA2jLwaLew40bN27cuHEH3Jdtt6DJsbUB03YJ2pJ0K0y/6FXixo0bN27cuGPuJHbJC6O2FGsbcltDq426ttUWG8CNGzdu3LhxH0qxthDcys28xdVGVPmFaEOr6GBw48aNGzdu3FMN0x7ANkxzLwrz0aIENF/PvVDGjRs3bty4cX+egM1Dqy3q2tpy+ZPbp22NtwfCPty4cePGjRt3vNM8MHq2SdaWWVuU1u6lxa0/x40bN27cuHEHyUnesspLwzbMerZwvLS4Lnv85l7jxo0bN27cuF/UJC3idhiXAZptyCZf1dZdTIabCz7cuHHjxo0bdzyY0raU7k/OmZLQahs7fn/J6sYebty4cePGjTuegWnbY3k5mNNsoFs4dTnIsRDEjRs3bty4cZ+5c9DLAWxYbYDVfvfC/Q06bty4cePGjfvtQM9WQrVLz5tbTx1JPgx0H0X6JsbCjRs3bty4cXdzO8V/hJyHWfnYzVNjQPfPc/q2lYgbN27cuHHjfv+LbcSzxTdJCfhUAy8fEmq/VTfJtqoTN27cuHHjxl2OubRF0vacPNLayta8VN0uLm7cuHHjxo07577ETwnfU+HRVsxtpW27u7z5hxs3bty4ceOO+0F1QNM22/KDyS9BXsLma2vjtqcOGzdu3Lhx48bdjuTmhdEF9166bVHXJcyKdoEbN27cuHHjLnexxVV54ZhvuC3Lno3M3j+5LUBx48aNGzdu3Bt3GzPdC7stACqGacrfasvBdkgIN27cuHHjxp1EVG1B1hZYz8ZA2y8mZeXWOIyuCG7cuHHjxo17ykzuzbNk6e38UU7TFqDb55dQDDdu3Lhx48b9ao8Jx/39fRt5WZavIYnY2vV8c69x48aNGzdu3AF3W/zdA6/8gNt+4E8EbW0FjRs3bty4ceP+O9x5IPVUAHQvwi75XL62KCDDjRs3bty4cT/E3W54G4u5hF9PlZX5YedHghs3bty4cePOubfRnLYMSgqyDfT+tLwV1x4hbty4cePGjfvZ1xZj5Uu/H0ne8Hvq79v4DDdu3Lhx48b9lvsf5ZdSv+KgpLwAAAAASUVORK5CYII=" alt="微信分享二维码"></div><script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script><script>var BLOG={ROOT:"/",SHARE:!0,REWARD:!0}</script><script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script><div class="search-panel" id="search-panel"><ul class="search-result" id="search-result"></ul></div><template id="search-tpl"><li class="item"><a href="{path}" class="waves-block waves-effect"><div class="title ellipsis" title="{title}">{title}</div><div class="flex-row flex-middle"><div class="tags ellipsis">{tags}</div><time class="flex-col time">{date}</time></div></a></li></template><script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>!function(){var t,e=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="朸?渄恴g个?喏o溊客??f",clearTimeout(t)):(document.title="(つェ⊂)咦!又好了!",t=setTimeout(function(){document.title=e},2e3))})}()</script></body></html><!-- rebuild by neat -->